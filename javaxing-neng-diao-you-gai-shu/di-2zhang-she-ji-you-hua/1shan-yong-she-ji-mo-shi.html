<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2.1 善用设计模式 | RollStones·笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="https://portrait.gitee.com/uploads/avatars/user/605/1817167_rollstone_1610068601.png!avatar60">
    <meta name="description" content="一点一滴记录，持之以恒学习。">
    
    <link rel="preload" href="/assets/css/0.styles.7385e7f5.css" as="style"><link rel="preload" href="/assets/js/app.d9144f6d.js" as="script"><link rel="preload" href="/assets/js/2.37ae8396.js" as="script"><link rel="preload" href="/assets/js/3.5aeea859.js" as="script"><link rel="prefetch" href="/assets/js/10.2de792d8.js"><link rel="prefetch" href="/assets/js/100.f001da9a.js"><link rel="prefetch" href="/assets/js/101.dc867a39.js"><link rel="prefetch" href="/assets/js/102.195acdd9.js"><link rel="prefetch" href="/assets/js/103.15e1f1fe.js"><link rel="prefetch" href="/assets/js/104.da807df0.js"><link rel="prefetch" href="/assets/js/105.58cc2e29.js"><link rel="prefetch" href="/assets/js/106.e25931e6.js"><link rel="prefetch" href="/assets/js/107.b4b35dfa.js"><link rel="prefetch" href="/assets/js/108.fb96d901.js"><link rel="prefetch" href="/assets/js/109.2a0f6b11.js"><link rel="prefetch" href="/assets/js/11.e0ae94eb.js"><link rel="prefetch" href="/assets/js/110.61222413.js"><link rel="prefetch" href="/assets/js/111.be0996a6.js"><link rel="prefetch" href="/assets/js/112.1a364d14.js"><link rel="prefetch" href="/assets/js/113.3d5eaffb.js"><link rel="prefetch" href="/assets/js/114.43f321e9.js"><link rel="prefetch" href="/assets/js/115.1a240b6f.js"><link rel="prefetch" href="/assets/js/116.4b7753ef.js"><link rel="prefetch" href="/assets/js/117.0b6a493b.js"><link rel="prefetch" href="/assets/js/118.237adc24.js"><link rel="prefetch" href="/assets/js/119.e9d1d737.js"><link rel="prefetch" href="/assets/js/12.818babcb.js"><link rel="prefetch" href="/assets/js/120.d72033cd.js"><link rel="prefetch" href="/assets/js/121.ee195c9f.js"><link rel="prefetch" href="/assets/js/122.49c233c1.js"><link rel="prefetch" href="/assets/js/123.f818c0be.js"><link rel="prefetch" href="/assets/js/124.f34ec6ae.js"><link rel="prefetch" href="/assets/js/125.1d1567e0.js"><link rel="prefetch" href="/assets/js/126.9565eb40.js"><link rel="prefetch" href="/assets/js/127.0da4c68c.js"><link rel="prefetch" href="/assets/js/128.852c8672.js"><link rel="prefetch" href="/assets/js/129.cf315d99.js"><link rel="prefetch" href="/assets/js/13.b6bc2652.js"><link rel="prefetch" href="/assets/js/130.814aa68b.js"><link rel="prefetch" href="/assets/js/131.c68d8ed6.js"><link rel="prefetch" href="/assets/js/132.14828589.js"><link rel="prefetch" href="/assets/js/133.e28b0e25.js"><link rel="prefetch" href="/assets/js/134.5c8b8625.js"><link rel="prefetch" href="/assets/js/135.137dbcb5.js"><link rel="prefetch" href="/assets/js/136.488c258a.js"><link rel="prefetch" href="/assets/js/137.bb3470b4.js"><link rel="prefetch" href="/assets/js/138.963e7285.js"><link rel="prefetch" href="/assets/js/139.5e04a80f.js"><link rel="prefetch" href="/assets/js/14.7344d085.js"><link rel="prefetch" href="/assets/js/140.355355c5.js"><link rel="prefetch" href="/assets/js/141.2b8c1f2c.js"><link rel="prefetch" href="/assets/js/142.c3bcb983.js"><link rel="prefetch" href="/assets/js/143.53ad9675.js"><link rel="prefetch" href="/assets/js/144.a6df48af.js"><link rel="prefetch" href="/assets/js/145.078fa1b8.js"><link rel="prefetch" href="/assets/js/146.9ddfc19e.js"><link rel="prefetch" href="/assets/js/147.9cd639e4.js"><link rel="prefetch" href="/assets/js/148.444a496a.js"><link rel="prefetch" href="/assets/js/149.1f834148.js"><link rel="prefetch" href="/assets/js/15.8b4f0a19.js"><link rel="prefetch" href="/assets/js/150.f0399c93.js"><link rel="prefetch" href="/assets/js/151.770b2ed6.js"><link rel="prefetch" href="/assets/js/152.4f0aacee.js"><link rel="prefetch" href="/assets/js/153.f8df82c6.js"><link rel="prefetch" href="/assets/js/154.eac81cc6.js"><link rel="prefetch" href="/assets/js/155.92743a96.js"><link rel="prefetch" href="/assets/js/156.2880b244.js"><link rel="prefetch" href="/assets/js/157.cc4a0c11.js"><link rel="prefetch" href="/assets/js/158.8bf44fb5.js"><link rel="prefetch" href="/assets/js/159.986f5a88.js"><link rel="prefetch" href="/assets/js/16.80575a0b.js"><link rel="prefetch" href="/assets/js/160.76913b1d.js"><link rel="prefetch" href="/assets/js/161.da8930be.js"><link rel="prefetch" href="/assets/js/162.445f1609.js"><link rel="prefetch" href="/assets/js/163.577a9227.js"><link rel="prefetch" href="/assets/js/164.b088fdb5.js"><link rel="prefetch" href="/assets/js/165.d58831ce.js"><link rel="prefetch" href="/assets/js/166.8658be3e.js"><link rel="prefetch" href="/assets/js/167.71cccdd6.js"><link rel="prefetch" href="/assets/js/168.c1ea18da.js"><link rel="prefetch" href="/assets/js/169.be170a86.js"><link rel="prefetch" href="/assets/js/17.a13eca2b.js"><link rel="prefetch" href="/assets/js/170.08aaca48.js"><link rel="prefetch" href="/assets/js/171.9c8c6ddc.js"><link rel="prefetch" href="/assets/js/172.fcb6bfd7.js"><link rel="prefetch" href="/assets/js/173.f739c68c.js"><link rel="prefetch" href="/assets/js/174.78720caf.js"><link rel="prefetch" href="/assets/js/175.2569130a.js"><link rel="prefetch" href="/assets/js/176.7e223dbb.js"><link rel="prefetch" href="/assets/js/177.0cecf756.js"><link rel="prefetch" href="/assets/js/178.f8103207.js"><link rel="prefetch" href="/assets/js/179.2245c549.js"><link rel="prefetch" href="/assets/js/18.c5e61a24.js"><link rel="prefetch" href="/assets/js/180.6e0bc22d.js"><link rel="prefetch" href="/assets/js/181.fed77bd0.js"><link rel="prefetch" href="/assets/js/182.812d2b3d.js"><link rel="prefetch" href="/assets/js/183.ef134cb2.js"><link rel="prefetch" href="/assets/js/184.a4312abd.js"><link rel="prefetch" href="/assets/js/185.52a4295a.js"><link rel="prefetch" href="/assets/js/186.10e813fe.js"><link rel="prefetch" href="/assets/js/187.ec71269e.js"><link rel="prefetch" href="/assets/js/188.62fa3814.js"><link rel="prefetch" href="/assets/js/189.013df69e.js"><link rel="prefetch" href="/assets/js/19.de97d44f.js"><link rel="prefetch" href="/assets/js/190.3fa67a4f.js"><link rel="prefetch" href="/assets/js/191.820f4cd0.js"><link rel="prefetch" href="/assets/js/192.878effaa.js"><link rel="prefetch" href="/assets/js/193.70198a9c.js"><link rel="prefetch" href="/assets/js/194.43ac300f.js"><link rel="prefetch" href="/assets/js/195.0b3de38c.js"><link rel="prefetch" href="/assets/js/196.f37c5f6a.js"><link rel="prefetch" href="/assets/js/197.a70d9271.js"><link rel="prefetch" href="/assets/js/198.a7767623.js"><link rel="prefetch" href="/assets/js/199.49056ec7.js"><link rel="prefetch" href="/assets/js/20.4c9cd3ac.js"><link rel="prefetch" href="/assets/js/200.f79ccb8d.js"><link rel="prefetch" href="/assets/js/201.bd52a247.js"><link rel="prefetch" href="/assets/js/202.77ba6fcc.js"><link rel="prefetch" href="/assets/js/203.3fd38c4a.js"><link rel="prefetch" href="/assets/js/204.493f4aad.js"><link rel="prefetch" href="/assets/js/205.e353e389.js"><link rel="prefetch" href="/assets/js/206.8b8fdbba.js"><link rel="prefetch" href="/assets/js/207.8a96800f.js"><link rel="prefetch" href="/assets/js/208.60a5c2ac.js"><link rel="prefetch" href="/assets/js/209.180dbdee.js"><link rel="prefetch" href="/assets/js/21.0599e6d2.js"><link rel="prefetch" href="/assets/js/210.1dc54834.js"><link rel="prefetch" href="/assets/js/211.d8d9b63d.js"><link rel="prefetch" href="/assets/js/212.1b3fd4a9.js"><link rel="prefetch" href="/assets/js/213.5304adcf.js"><link rel="prefetch" href="/assets/js/214.8f743ba3.js"><link rel="prefetch" href="/assets/js/215.03cc8b66.js"><link rel="prefetch" href="/assets/js/216.ef93b5c4.js"><link rel="prefetch" href="/assets/js/217.0f0bcdae.js"><link rel="prefetch" href="/assets/js/218.24d07b1c.js"><link rel="prefetch" href="/assets/js/219.be460c95.js"><link rel="prefetch" href="/assets/js/22.bf9a1a15.js"><link rel="prefetch" href="/assets/js/220.b74851a0.js"><link rel="prefetch" href="/assets/js/221.9b72aff4.js"><link rel="prefetch" href="/assets/js/222.167895e6.js"><link rel="prefetch" href="/assets/js/223.1cfb108e.js"><link rel="prefetch" href="/assets/js/224.5cc2e228.js"><link rel="prefetch" href="/assets/js/225.6408f8ee.js"><link rel="prefetch" href="/assets/js/226.ffe542c4.js"><link rel="prefetch" href="/assets/js/23.1c869369.js"><link rel="prefetch" href="/assets/js/24.e4024dd4.js"><link rel="prefetch" href="/assets/js/25.e92af0dd.js"><link rel="prefetch" href="/assets/js/26.fbf4967a.js"><link rel="prefetch" href="/assets/js/27.00f4c2bc.js"><link rel="prefetch" href="/assets/js/28.eb06bd91.js"><link rel="prefetch" href="/assets/js/29.3215cbfd.js"><link rel="prefetch" href="/assets/js/30.4d19b4c0.js"><link rel="prefetch" href="/assets/js/31.60886406.js"><link rel="prefetch" href="/assets/js/32.20886f19.js"><link rel="prefetch" href="/assets/js/33.7a9f6c0a.js"><link rel="prefetch" href="/assets/js/34.07b97846.js"><link rel="prefetch" href="/assets/js/35.d51ade57.js"><link rel="prefetch" href="/assets/js/36.aaa51e62.js"><link rel="prefetch" href="/assets/js/37.83e368c6.js"><link rel="prefetch" href="/assets/js/38.460cc21f.js"><link rel="prefetch" href="/assets/js/39.3d60dbdd.js"><link rel="prefetch" href="/assets/js/4.a63a4070.js"><link rel="prefetch" href="/assets/js/40.74a3069e.js"><link rel="prefetch" href="/assets/js/41.7c72eb0e.js"><link rel="prefetch" href="/assets/js/42.e52eafad.js"><link rel="prefetch" href="/assets/js/43.c2460c21.js"><link rel="prefetch" href="/assets/js/44.49b69202.js"><link rel="prefetch" href="/assets/js/45.ca830dd3.js"><link rel="prefetch" href="/assets/js/46.feff336b.js"><link rel="prefetch" href="/assets/js/47.1c0896a8.js"><link rel="prefetch" href="/assets/js/48.2317a641.js"><link rel="prefetch" href="/assets/js/49.826945bc.js"><link rel="prefetch" href="/assets/js/5.65ca3e83.js"><link rel="prefetch" href="/assets/js/50.4b48afd2.js"><link rel="prefetch" href="/assets/js/51.88824fd2.js"><link rel="prefetch" href="/assets/js/52.695ed89b.js"><link rel="prefetch" href="/assets/js/53.1453e41a.js"><link rel="prefetch" href="/assets/js/54.f138c0e9.js"><link rel="prefetch" href="/assets/js/55.ff80933e.js"><link rel="prefetch" href="/assets/js/56.b5845a07.js"><link rel="prefetch" href="/assets/js/57.5fa3b21f.js"><link rel="prefetch" href="/assets/js/58.1367f3b4.js"><link rel="prefetch" href="/assets/js/59.e423c723.js"><link rel="prefetch" href="/assets/js/6.c5bb8f3e.js"><link rel="prefetch" href="/assets/js/60.96621a38.js"><link rel="prefetch" href="/assets/js/61.7b48947d.js"><link rel="prefetch" href="/assets/js/62.000c3176.js"><link rel="prefetch" href="/assets/js/63.2b52a9f7.js"><link rel="prefetch" href="/assets/js/64.398296e9.js"><link rel="prefetch" href="/assets/js/65.90fdb846.js"><link rel="prefetch" href="/assets/js/66.ef09e78d.js"><link rel="prefetch" href="/assets/js/67.b23ebf2a.js"><link rel="prefetch" href="/assets/js/68.f2432117.js"><link rel="prefetch" href="/assets/js/69.719e9c1c.js"><link rel="prefetch" href="/assets/js/7.8869e8ec.js"><link rel="prefetch" href="/assets/js/70.9c045b12.js"><link rel="prefetch" href="/assets/js/71.fd154bf9.js"><link rel="prefetch" href="/assets/js/72.392adc49.js"><link rel="prefetch" href="/assets/js/73.bf97d210.js"><link rel="prefetch" href="/assets/js/74.e0ca5bd5.js"><link rel="prefetch" href="/assets/js/75.baf97fc9.js"><link rel="prefetch" href="/assets/js/76.d22cf157.js"><link rel="prefetch" href="/assets/js/77.140a42db.js"><link rel="prefetch" href="/assets/js/78.2cae7a40.js"><link rel="prefetch" href="/assets/js/79.31ace155.js"><link rel="prefetch" href="/assets/js/8.77202eac.js"><link rel="prefetch" href="/assets/js/80.0bcc2452.js"><link rel="prefetch" href="/assets/js/81.f24c2150.js"><link rel="prefetch" href="/assets/js/82.f1676137.js"><link rel="prefetch" href="/assets/js/83.63c5fef8.js"><link rel="prefetch" href="/assets/js/84.8f099aad.js"><link rel="prefetch" href="/assets/js/85.0ff1685a.js"><link rel="prefetch" href="/assets/js/86.8670b4d2.js"><link rel="prefetch" href="/assets/js/87.d7f0e264.js"><link rel="prefetch" href="/assets/js/88.ae445553.js"><link rel="prefetch" href="/assets/js/89.a36446fd.js"><link rel="prefetch" href="/assets/js/9.1ccb07cf.js"><link rel="prefetch" href="/assets/js/90.88609a64.js"><link rel="prefetch" href="/assets/js/91.41480a41.js"><link rel="prefetch" href="/assets/js/92.4007406c.js"><link rel="prefetch" href="/assets/js/93.299c852a.js"><link rel="prefetch" href="/assets/js/94.cd869297.js"><link rel="prefetch" href="/assets/js/95.b55aa66d.js"><link rel="prefetch" href="/assets/js/96.82f921e1.js"><link rel="prefetch" href="/assets/js/97.46c181a7.js"><link rel="prefetch" href="/assets/js/98.a65d6414.js"><link rel="prefetch" href="/assets/js/99.8ab1355c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7385e7f5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">RollStones·笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/webkai-fa/" class="nav-link">
  Web开发
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/js/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/mian-shi-ti/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/javaxing-neng-diao-you-gai-shu/" class="nav-link router-link-active">
  Java性能调优概述
</a></div><div class="nav-item"><a href="/javaxing-neng-diao-you-a-li-/" class="nav-link">
  Java性能调优 阿里
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/webkai-fa/" class="nav-link">
  Web开发
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/js/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/mian-shi-ti/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/javaxing-neng-diao-you-gai-shu/" class="nav-link router-link-active">
  Java性能调优概述
</a></div><div class="nav-item"><a href="/javaxing-neng-diao-you-a-li-/" class="nav-link">
  Java性能调优 阿里
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第 1 章 Java性能调优概述</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>第 2 章设计优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html" aria-current="page" class="active sidebar-link">2.1 善用设计模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html#_2-1-1-单例模式" class="sidebar-link">2.1.1 单例模式</a></li><li class="sidebar-sub-header"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html#_2-1-2-代理模式" class="sidebar-link">2.1.2 代理模式</a></li><li class="sidebar-sub-header"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html#_2-1-3-享元模式" class="sidebar-link">2.1.3 享元模式</a></li><li class="sidebar-sub-header"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html#_2-1-4-装饰者模式" class="sidebar-link">2.1.4 装饰者模式</a></li><li class="sidebar-sub-header"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html#_2-1-5-观察者模式" class="sidebar-link">2.1.5 观察者模式</a></li><li class="sidebar-sub-header"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html#_2-1-6-value-object模式" class="sidebar-link">2.1.6 Value Object模式</a></li><li class="sidebar-sub-header"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/1shan-yong-she-ji-mo-shi.html#_2-1-7-业务代理模式" class="sidebar-link">2.1.7 业务代理模式</a></li></ul></li><li><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/chang-yong-you-hua-zu-jian-he-fang-fa.html" class="sidebar-link">2.2 常用优化组件和方法</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>第 3 章 Java程序优化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_2-1-善用设计模式"><a href="#_2-1-善用设计模式" class="header-anchor">#</a> 2.1 善用设计模式</h1> <p>本章主要介绍与软件设计相关的性能优化方法和思想。软件的结构对系统整体性能有着重要的影响。优秀的设计结构可以规避很多潜在的性能问题，对系统性能的影响可能远远大于代码的优化。因此熟悉一些常用的软件设计模式和方法，对设计高性能软件有着重要的帮助。本章着眼于设计优化，主要讲解了一些常用的与性能相关的设计模式、组件和设计方法。</p> <p>​		本章涉及的主要知识点有：</p> <ul><li>单例模式的使用和实现</li> <li>代理模式的实现和深入剖析</li> <li>享元模式的应用</li> <li>装饰者模式对性能组件的封装</li> <li>观察者模式的使用</li> <li>使用 Value Object 模式减少网络数据传输</li> <li>使用业务代理模式添加远程调用缓存</li> <li>缓冲和缓存的定义和使用</li> <li>对象池的使用场景及其基本实现</li> <li>构建负载均衡系统以及Terracotta框架的简单使用</li> <li>时间换空间和空间换时间的基本思路</li></ul> <p>​		设计模式是前人工作的总结和提炼。通常，被人们广泛流传的设计模式都是对某一特定问题的成熟的解决方案。如果能合理的使用设计模式，不仅能使系统更容易被他人理解，同时也能使系统用友更加合理的结构。本节总结归纳了一些景点的设计模式，并详细说明它们与软件性能之间的关系。</p> <h2 id="_2-1-1-单例模式"><a href="#_2-1-1-单例模式" class="header-anchor">#</a> 2.1.1 单例模式</h2> <p>​		单例模式是设计模式中使用最为普遍的模式之一。它是一种对象创建模式，用于产生一个对象的具体实例，它可以确保系统中一个类只产生一个实例。在Java语言中，这样的行为能带来两大好处：</p> <ol><li>对于频繁使用的对象，可以省略创建对象所花费的实际，这对于那些重量级对象而言，是非常可观的一笔系统开销。</li> <li>由于 new 操作的次数减少，因而对系统内存的使用频率也会降低，这将减轻GC压力，缩短GC停顿时间。</li></ol> <p>​	单例模式的参与者非常简单，只有单例类和使用者两个：</p> <table><thead><tr><th>角色</th> <th>作用</th></tr></thead> <tbody><tr><td>单例类</td> <td>提供单例的工厂，返回单例</td></tr> <tr><td>使用者</td> <td>获取并使用单例类</td></tr></tbody></table> <p>它的基本结构如图2.1所示：</p> <p><img src="/assets/img/2.1.42072bb3.png" alt=""></p> <p>单例模式的核心在于通过一个接口返回唯一的对象实例。一个简单的单例实现如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建单例的过程可能会比较慢</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Singleton is create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>​		<strong>首先单例类必须要有一个private访问级别的构造函数，只有这样，才能确保单例不会在系统中的其他代码中被实例化，这点是相当重要的；其次，instance 成员变量和 getInstance() 方法必须是static的。</strong></p> <p>​		这种单例的实现方式非常简单，而且十分可靠。它唯一的不足仅是无法对 instance 实例做延迟加载。加入单例的创建过程很慢，而由于 instance 成员变量的 static 定义的，因此在JVM加载单例类时，单例对象就会被建立，如果此时，这个单例类在系统中还扮演其他角色，那么在任何使用这个单例类的地方都会初始化这个单例变量，而不管是否会被用到。比如单例类作为String工厂，用于创建一些字符串（该类既用于创建单例 Singleton，有用于创建 String 对象）：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建单例的过程可能会比较慢</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Singleton is create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;createString is Singleton&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当使用 Singleton.createString() 执行任务时，程序输出：</p> <div class="language-tex extra-class"><pre class="language-tex"><code>Singleton is create
createString is Singleton
</code></pre></div><p>可以看到，虽然此时并没有使用单例类，但它还是被创建出来，这也许是开发人员所不愿意见到的。为了解决这个问题，并以此提高系统在相关函数调用时的反应速度，就需要引入延迟加载机制。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LazySingleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LazySingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建单例的过程可能会比较慢</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;LazySingleton is create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LazySingleton</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">LazySingleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>​		首先，对于静态成员变量 instance 初始值赋予 null，确保系统启动时没有额外的负载；其次在 getInstance() 工厂方法中，判断当前单例是否已经存在，若存在则返回，不存在则再创建实例。这里尤其还要注意，getInstance() 方法必须是同步的，否则在多线程环境下，当线程1正新建单例时，完成赋值操作前，线程2可能判断 instance 为null，故线程2也将启动新建单例的程序，而导致多个实例被创建，故同步关键字是必须的。</p> <p>​		使用上例中的单例实现，虽然实现了延迟加载的功能，但和第一种方法相比，它引入同步了关键字，因此在多线程环境中，它的耗时要远远大于第一种单例模式。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//Singleton.getInstance();</span>
    <span class="token class-name">LazySingleton</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;speed:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>开启5个线程同事完成以上代码的运行，使用第1种类型的单例耗时0ms，而使用第 LazySingleton 却相对耗时约290ms，性能至少相差2个数量级。</p> <p>​		为了使用延迟加载引入的同步关键字反而降低了系统性能，是不是有点得不偿失呢？为了解决这个问题，还需要对其进行改进：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StaticSingleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">StaticSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建单例的过程可能会比较慢</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;StaticSingleton is create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingletonHolder</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StaticSingleton</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">StaticSingleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> singletonHolder<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>​		在这个实现中，单例模式使用内部类来维护单例的实例，当 StaticSingleton 被加载时，其内部类并不会被初始化，故可以确保当 StaticSingleton  类被载入JVM时，不会初始化单例类，而当 getInstance() 方法被调用时，才会加载 SingletonHolder，从而初始化 instance。同时，由于实例的建立是在类加载时完成，故天生对多线程友好， getInstance() 方法也不需要使用同步关键字。因此，这种实现方式同事兼备以上两种实现的优点。</p> <p><strong>注意：使用内部类的方式实现单例，既可以做到延迟加载，也不必使用同步关键字，是一种比较完善的实现。</strong></p> <p>​		通常情况下，用以上方式实现的单例已经可以确保在系统中只存在唯一实例了。但仍然有例外情况，可能导致系统生成多个实例，比如，在代码中，通过反射机制，强行调用单例类的私有构造函数，生成多个实例。</p> <h2 id="_2-1-2-代理模式"><a href="#_2-1-2-代理模式" class="header-anchor">#</a> 2.1.2 代理模式</h2> <p>​		代理模式也是一种很常见的设计模式。它使用代理对象完成用户请求，屏蔽用户对真实对象的访问。就如同现实中的代理一样，代理人被授权执行当事人的一些事宜，而无需当事人出面，从第三方角度看，似乎当事人并不存在，因为它只和代理人通信。而事实上代理人也是要有当事人的授权，并且在核心问题上还需要请示当事人。</p> <p>​		在现实中，使用代理的情况很普遍，而且原因也很多。比如，当事人因为某些隐私不方便出面，或者当事人不具备某些相关的专业技能，而需要一个职业人员来完成一些专业的操作，也可能由于当事人没有时间处理事务，而聘用代理人出面。</p> <p>​		在软件设计中，使用代理模式的意图也很多，比如因为安全原因，需要屏蔽客户端直接访问真是对象；或者在远程调用中，需要使用代理类处理远程方法调用的技术细节（如RMI）；也可能是为了提升系统性能，对真是对象进行封装，从而达到延迟加载的目的。</p> <ol><li><p>代理模式的结构</p> <table><thead><tr><th>角色</th> <th>作用</th></tr></thead> <tbody><tr><td>主题接口</td> <td>定义代理类和真是主题的公共对外方法，也是代理类代理真是主题的方法</td></tr> <tr><td>真实主题</td> <td>真正实现业务逻辑的类</td></tr> <tr><td>代理类</td> <td>用来代理和封装真实主题</td></tr> <tr><td>Main</td> <td>客户端，使用代理类和主题接口完成一些工作</td></tr></tbody></table> <p>以一个简答的示例来阐述使用代理模式实现延迟加载的方法及其意义。假设某客户端软件，有根据用户请求，去数据库查询数据的功能。在查询数据前，需要获得数据库连接，软件开启时，初始化系统的所有类，此时尝试获取数据库连接。单系统有大量的类似操作存在时（比如Xml解析等），所有这些初始化操作的叠加，会使得系统的启动速度变得非常缓慢。为此，使用代理模式，使用代理类，封装对数据库查询中的初始化操作，当系统启动时，初始化这个代理类，而非真是的数据库查询类，而代理类什么都没有做，因此它的构造是相当迅速的。</p> <p>在系统启动时，将消耗资源最多的方法都使用代理模式分离，就可以加快系统的启动速度，减少用户的等待时间。而在用户真正做查询操作时，再由代理类，单独去加载真实的数据库查询类，完成用户的请求。这个过程就是使用代理模式实现了延迟加载。</p> <p><strong>注意：代理模式可以用于多种场合，如用于远程调用的网络代理、考虑安全因素的安全代理等。延迟加载只是代理模式的一种应用场景。</strong></p> <p>延迟加载的核心思想是：如果当前并没有使用这个组件，则不需要真正的初始化它，使用一个代理对象替代它的原有的位置，只要在真正需要使用的时候，才对它进行加载。使用代理模式的延迟加载是非常有意义的，首先，它可以再时间轴上分散系统压力，尤其在系统启动时，不必完成所有的初始化工作，从而加速启动时间；其次，对很多真实主题而言，在软件启动直到被关闭的整个过程中，可能根本不会被调用，初始化这些数据无疑是一种资源浪费。</p> <p>图2.2显示了使用代理类封装数据库查询类后，系统的启动过程：</p> <p><img src="/assets/img/2.2.1a12622d.png" alt=""></p> <p>若系统不使用代理模式，则在启动时就要初始化DBQuery对象，而使用代理模式后，启动时只需要初始化一个轻量级的对象DBQueryProxy。</p> <p>系统的结构图如图2.3所示，IDBQuery 是主题接口，定义代理类和真实类需要对外提供的服务，在本例中定义了实现数据库查询的公共方法request() 函数。DBQuery是真实主题，负责实际的业务操作，DBQueryProxy是DBQuery 的代理类。</p></li> <li><p>代理模式的实现和使用
基于以上设计，IDBQuery的实现如下，它只有一个request()方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> intreface <span class="token class-name">IDBQuery</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/assets/img/2.3.9e390134.png" alt=""></p> <p>DBQuery实现如下。它是一个重量级对象，构造会比较慢：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DBQuery</span> <span class="token keyword">implements</span> <span class="token class-name">IDBQuery</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">DBQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment">//模拟数据库连接等耗时操作</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        retrun <span class="token string">&quot;request String&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代理类DBQueryProxy 是轻量级对象，创建很快，用于代替DBQuery的位置：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DBQueryProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IDBQuery</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">DBQuery</span> real <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//在真正需要的时候，才创建真实对象，创建过程可能很慢</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>real <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            real <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//在多线程环境下，这里返回一个虚假类，类似于Future模式</span>
            <span class="token keyword">return</span> real<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后，主函数如下，它引用 IDQuery 接口，并使用代理类工作：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//使用代理</span>
        <span class="token class-name">IDBQuery</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBQueryProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在真正使用时才创建真实对象</span>
        query<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注意：将代理模式用于实现延迟加载，可以有效地提升系统的启动速度，对改善用户体验有很大的帮助。</strong></p></li> <li><p>动态代理介绍</p> <p>动态代理是指在运行时，动态生成代理类。</p> <p>即，代理类的字节码将在运行时生成并载入当前的ClassLoader。与静态代理类相比，动态类有诸多好处。
首先，不需要为真实主题写一个形式上完全一样的封装类，加入主题接口中的方法很多，为每一个接口写一个代理方法也是非常烦人的事，如果接口有变动，则真实主题和代理类都要修改，不利于系统维护；
其次使用一些动态代理的生成方法甚至可以在运行时指定代理类的执行逻辑，从而大大提升系统的灵活性。</p> <p><strong>注意：动态代理使用字节码动态生成加载技术，在运行时生成并加载类</strong></p> <p>生成动态代理类的方法很多，如JDK中自带的动态代理、CGLIB、Javassist 或者 ASM库。JDK的动态代理使用简单，它内置在JDK中，因此不需要引入第三方Jar包，但相对功能比较弱。CGLIB和Javassist都是高级的字节码生成库，总体性能比JDK自带的动态代理好，而且功能十分强大。ASM是低级的字节码生成工具，使用ASM已经近乎于在使用 Java bytecode 编程，对开发人员要求最高，当然也是性能最好的一种动态代理生成工具。但ASM的使用实在过于繁琐，而且性能也没有数量级的提升，与CGLIB等高级字节码生成工具相比，ASM程序的可维护性也较差，如果不是在对性能有苛刻要求的场合，还是推荐CGLIB 或者 Javassist。</p></li> <li><p>动态代理实现
以上例中的DBQueryProxy为例，使用动态代理生成动态类，代替上例中的DBQueryProxy。首先，使用JDK的动态代理生成代理对象。JDK的动态代理需要实现一个处理方法调用的Handler，用于实现代理方法的内部逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdkDbQueryHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">{</span>
    <span class="token class-name">IDBQuery</span> real <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>real <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//如果是第一次调用，则成成真实对象</span>
            real <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//使用真实主题完成实际的操作</span>
            <span class="token keyword">return</span> real<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码实现了一个Handler，可以看到，它的内部逻辑和DBQueryProxy是类似的。在调用真实主题的方法前，先尝试生成真实主题对象。接着，需要使用这个Handler生成动态代理对象：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IDBQuery</span> <span class="token function">creatJdkProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">IDBQuery</span> jdkProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IDBQuery</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">IDBQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JdkDbQueryHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定Handler</span>
    <span class="token keyword">return</span> jdkProxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码生成一个实现了I'DQuery接口的代理类，代理类的内部逻辑由JDKDBQueryHandler 决定。生成代理类后，有 newProxyInstance() 方法返回该代理类的一个实例。至此，一个完整的JDK动态代理就完成了。
CGLIB 和 Javassist的动态代理的使用和JDK的动态代理非常类似。下面，尝试使用CGLIB生成动态代理。CGLIB 也需要实现一个处理代理逻辑的切入类：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CglibDBQueryInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">{</span>
    <span class="token class-name">IDBQuery</span> real <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> arg0<span class="token punctuation">,</span> <span class="token class-name">Method</span> arg1<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg2<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> arg3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">{</span>
        <span class="token comment">//代理类的内部逻辑,和前文中的一样</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>real <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            real <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> real<span class="token punctuation">.</span><span class="token function">requedt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个切入对象的基础上，可以生成动态代理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IDBQuery</span> <span class="token function">createCglibProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 指定切入器，定义代理类逻辑</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CglibDbQueryInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//指定实现的接口</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">IDBQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//生成代理类的实例</span>
    <span class="token class-name">IDBQuery</span> cglibProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IDBQuery</span><span class="token punctuation">)</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cglibProxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用Javassist生成动态代理可以使用两种方式：一种是使用代理工厂创建，另一种通过使用动态代码创建。使用代理工厂创建时，方法与CGLIB类似，也需要实现一个用于代理逻辑处理的Handler：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavassistDynDbQueryHandler</span> <span class="token keyword">implements</span> <span class="token class-name">MethodHandler</span><span class="token punctuation">{</span>
    <span class="token class-name">IDBQuery</span> real <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> arg0<span class="token punctuation">,</span> <span class="token class-name">Mehtod</span> arg1<span class="token punctuation">,</span> <span class="token class-name">Method</span> arg3<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">{</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>real <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           real <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> real<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以这个Handler为基础，创建动态Javassist代理：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IDBQuery</span> <span class="token function">createJavassistDynProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token class-name">ProxyFactory</span> proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//指定接口</span>
    proxyFactory<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">IDBQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span> proxyClass proxyFactory<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IDBQuery</span> javassistProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IDBQuery</span><span class="token punctuation">)</span> proxyClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置Handler处理器</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ProxyObject</span><span class="token punctuation">)</span> javassistProxy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JavassistDynDbQueryHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> javassistProxy
<span class="token punctuation">}</span>
</code></pre></div><p>Javassist 使用动态Java代码创建代理的过程和前文的方法略有不同。Javassist内部可以通过动态代码，生成字节码。这种方式创建的动态代理可以非常灵活，甚至可以在运行时生成业务逻辑。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IDBQuery</span> <span class="token function">createJavassistBytecodeDynamicProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> thows <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token class-name">ClassPool</span> mPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//定义类名</span>
    <span class="token class-name">CtClass</span> mCtc <span class="token operator">=</span> mPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token class-name">IDBQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;JavassistBytecodeProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//需要实现的接口</span>
    mCtc<span class="token punctuation">.</span><span class="token function">addInterface</span><span class="token punctuation">(</span>mPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">IDBQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//添加构造函数</span>
    mCtc<span class="token punctuation">.</span><span class="token function">addConstructor</span><span class="token punctuation">(</span><span class="token class-name">CtNewConstructor</span><span class="token punctuation">.</span><span class="token function">defaultConstructor</span><span class="token punctuation">(</span>mCtc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//添加类的字段信息，使用动态Java代码</span>
    mCtc<span class="token punctuation">.</span><span class="token function">addField</span><span class="token punctuation">(</span><span class="token class-name">CtField</span><span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token string">&quot;public &quot;</span><span class="token operator">+</span><span class="token class-name">IDBQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span>getName <span class="token operator">+</span> <span class="token string">&quot;real;&quot;</span><span class="token punctuation">,</span>mCtc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> dbqueryname <span class="token operator">=</span> <span class="token class-name">DBQuery</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//添加方法，这里使用动态Java 代码指定内部逻辑</span>
    mCtc<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span><span class="token class-name">CtNewMethod</span><span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token string">&quot;public String request() {if(real == null) {real = new &quot;</span><span class="token operator">+</span>dbvqueryname <span class="token operator">+</span><span class="token string">&quot;();return real.request();}}&quot;</span><span class="token punctuation">,</span>mCtc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//基于以上信息，生成动态类</span>
    <span class="token class-name">Class</span> pc <span class="token operator">=</span> mCtc<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//生成动态类的实例</span>
    <span class="token class-name">IDBQuery</span>  bytecodeProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IDBQuery</span><span class="token punctuation">)</span> pc<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bytecodeProxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在以上代码中，使用CTField.make() 方法和 CtNewMethod.make() 方法在运行时生成了代理的字段和方法。这些逻辑有Javassist 的CtClass对象处理，将Java代码转换为对应的字节码，并成成动态代理类的实例。</p> <p><strong>注意: 与静态代理相比，动态代理可以很大幅度的减少代码行数，并提升系统灵活性</strong></p> <p>在Java中，动态代理类的生产主要设计对ClassLoader的使用。这里以CGLIB为例，简要阐述动态类的加载过程。使用CGLIB生成动态代理，首先需要生成Enhancer类实例，并指定用于处理代理业务的回调类。在Enhancer.create() 方法中，会只用DefaultGeneratorStrategy.generate() 方法生成动态代理类的字节码，并保存再byte数组中。接着使用ReflectUtils.defineClass() 方法,通过反射，调用 ClassLoader.defineClass() 方法，将字节码装载到ClassLoader中，完成类的加载。最后使用 ReflectUtils.newInstance() 方法，通过反射生成动态代理类的实例，并返回该实例。无论使用哪种方法生成动态代理，虽然实现细节不同，单主要逻辑都如图2.4所示：</p> <p><img src="/assets/img/2.4.31c4af11.png" alt="">
前文介绍的几种动态代理的生成方法，性能有一定差异。为了能更好的测试他们的性能，去掉DBQuery类中的Sleep代码，并使用一下方法测试:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CIRCLE <span class="token operator">=</span> <span class="token number">30000000</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token class-name">IDBQuery</span> d <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//测试JDK动态代理</span>
    d <span class="token operator">=</span> <span class="token function">creteJdkProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;createJdkProxy:&quot;</span><span class="token operator">+</span>d<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>CIRCLE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        d<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;callJdkProxy:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token operator">=</span><span class="token function">createCglibProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//测试DGLIB动态代理</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;createCglibProxy:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CglibProxy:&quot;</span><span class="token operator">+</span>d<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>CIRCLE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        d<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;callCglibProxy:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token operator">=</span><span class="token function">createJavassistDynProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//测试Javassist动态代理</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;createJavassistDynProxy:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;JavassistDynProxy:&quot;</span><span class="token operator">+</span>d<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>CIRCLE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        d<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;callJavassistDynProxy:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token operator">=</span><span class="token function">createJavassistBytecodeDynamicProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//测试Javassist动态代理</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;createJavassistBytecodeDynamicProxy:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;JavassistBytecodeDynamicProxy:&quot;</span><span class="token operator">+</span>d<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>CIRCLE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        d<span class="token punctuation">.</span>request<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;callJavassistBytecodeDynamicProxy:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token class-name">CurrentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码分别生成了4种代理，并对生成的代理类进行高频率的调用，最后输出各代理类的创建耗时，动态类名和方法调用耗时。结果如下：</p> <p><img src="/assets/img/2.4.1.aef1bd25.png" alt=""></p> <p>可以看出，JDK的动态类创建过程做快，这是因为这个内置实现中defineClass()方法被定义为native实现，故性能高于其他几种实现。但在代理类的函数调用性能上，JDK的动态代理就不如CGLIB和Javassist的基于动态代码的代理，而Javassist的基于代理工厂的代理实现，代理性能质量最差，甚至不如JDK的实现。在实际开发应用中，代理类的方法调用频率通常要远远高于代理类的实际生成频率（相同类的重复生成会使用cache），故动态代理对象的方法调用性能应该作为性能的主要关注点。</p> <p><strong>注意：就动态代理的方法调用性能而言，CGLIB和 Javassist的基于动态代码的代理都优于JDK自带的动态代理。此外，JDK的动态代理要求代理类和真实主题都实现同一个接口，而CGLIB和Javassist没有强制要求</strong></p></li> <li><p>Hibernate中代理模式的应用</p></li></ol> <p>用代理模式实现延迟加载的一个经典应用就在Hibernate框架中。当Hibernate加载实体Ben时，并不会一次性将数据库所有的数据都装载。默认情况下，它会采取延时加载的机制，以提高系统的性能。Hibernate中的延迟加载主要有两种：一种是属性的延迟加载，二是关联表的延迟加载。这里以属性的延迟加载为例，简单阐述Hibernate是如何使用动态代理的。</p> <p>假定有用户模型：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token comment">//省略getter 和 setter</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用一下代码，通过Hibernate加载一条User信息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//从数据库载入ID为1的用户</span>
<span class="token class-name">User</span> u <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> <span class="token class-name">HibernateSessionFaction</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//打印类名称</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Class name:&quot;</span><span class="token operator">+</span>u<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//打印父类名称</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Supper Class name:&quot;</span><span class="token operator">+</span>u<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//实现的所有接口</span>
<span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ins <span class="token operator">=</span> u<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Class</span> cls<span class="token operator">:</span>ins<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;interface:&quot;</span><span class="token operator">+</span>cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>以上代码中，在session.load()方法后，首先输出了User的类名、它的超类、User实现的接口，最后输出调用User的getName()方法取得的数据库数据。这段程序的输出如下:</p> <p><img src="/assets/img/2.4.2.7d310042.png" alt=""></p> <p>仔细观察这段输出，可以看到，session的载入类并不是之前定义的User类，而是名叫javatuning.ch2.proxy.hibernate.User$$EnhancerByCGLIB$$96d498bed的类。从名称上可以推测，它是使用CGLIB的Enhancer类生成的动态类。该类的父类才是应用程序定义的User类。</p> <p>此外，它实现了HIbernateProxy接口。由此可见，Hibernate使用一个动态代理子类替代用户定义的类。这样在载入对象时，就不必初始化对象的所有信息，通过代理，拦截原有的getter方法，可以再真正使用对象数据时，才去数据库加载实际的数据，从而提升系统性能。由这段输出的顺序来看，也正是这样，在getName()被调用之前，Hibernate从未输出过一条SQL语句。这表示：User对象被加载时，根本就没有访问数据库，而在getName() 方法被调用时，才真正完成了数据库操作。</p> <p><strong>注意：Hibernate框架中对实体类的动态代理是代理模式用于延迟加载的经典实现。</strong></p> <h2 id="_2-1-3-享元模式"><a href="#_2-1-3-享元模式" class="header-anchor">#</a> 2.1.3 享元模式</h2> <p>享元模式是设计模式中少数几个以提高系统性能为目的的模式之一。</p> <p>它的核心思想是：如果再一个系统中存在多个相同的对象，那么只需共享一份对象的拷贝，而不必为一次使用都创建新的对象。在享元模式中，由于需要构造和维护这些可以共享的对象，因此，常常会出现一个工厂类，用于维护和创建对象。</p> <p>享元模式对性能提升的主要帮助有两点：</p> <ol><li><p>可以节省重复创建对象的开销，因为被享元模式维护的相同对象只会被创建一次，当创建对象比较耗时时，便可以节省大量时间。</p></li> <li><p>由于创建对象的数量减少，所以对系统内存的需求也减小，这将使得GC的压力也响应的降低，今儿使得系统拥有一个更健康的内存结构和更快的反应速度。</p> <p>享元模式的主要角色有享元工厂、抽象享元、具体享元类和主函数几部分组成。他们的功能如下：</p> <table><thead><tr><th>角色</th> <th>作用</th></tr></thead> <tbody><tr><td>享元工厂</td> <td>用以创建具体享元类，维护相同的享元对象。它保证相同的享元对象可以被系统共享。即，其内部使用了类似单例模式的算法，当请求对象已经存在时，直接返回对象，不存在时，再创建对象。</td></tr> <tr><td>抽象享元</td> <td>定义需共享的对象的业务接口。享元类被创建出来总是为了实现某些特定的业务逻辑，而抽象享元便定义这些逻辑的语义行为。</td></tr> <tr><td>具体享元类</td> <td>实现抽象享元类的接口，完成某一具体逻辑</td></tr> <tr><td>Main</td> <td>使用享元模式的组件，通过享元工厂取得享元对象</td></tr></tbody></table> <p>基于以上角色，享元模式的结构如下：</p> <p><img src="/assets/img/2.5.12bf5450.png" alt=""></p> <p>享元工厂是享元模式的核心，它需要确保系统可以共享相同的对象。一般情况下，享元=工厂会维护一个对象列表，当任何组件尝试获取享元类时，如果请求的享元类货已经被创建，则直接返回已有的享元类；若没有，则创建一个新的享元对象，并将它加入到维护队列中。</p> <p><strong>注意：享元模式是为数不多的、只为提升系统性能而生的设计模式。它的主要作用就是复用大对象（重量级对象），以节省内存空间和对象创建时间。</strong></p> <p>享元模式的一个经典应用是在SAAS系统中。SAAS即 Software As A Service，是目前比较流行的一中软件应用模式。</p> <p>以一个人事管理系统的SAAS软件为例，假设公司甲、乙、丙均为这个SAAS系统的用户，则定义每个公司为这套系统的一个租户。每个公司（租户）又各有100个员工。如果这些公司的所有员工都可以登录这套系统查看自己的收入情况，并且为了系统安全，每个公司（租户）都用友自己独立的数据库。为了使系统的设计最为合理，在这种情况下，便可以使用享元模式为每个租户分别提供工资查询的接口，而一个公司下的所有员工可以共享一个查询（因为一个租户下所有的员工数据都存放在一个数据库中，它们共享数据库连接）。这样，系统只需要3个享元实例，就足以应付300个员工的查询请求了。系统的结构图如下：</p> <p><img src="/assets/img/2.6.b5dd57e9.png" alt=""></p> <p>ReportManagerFactory 为享元工厂，负责创建具体的报表工具，它确保每个公司下所有的员工，都共享一个具体的享元实例（FinancialReportManager或者EmployeeReportManager）。这样，当公司甲的两个员工登录，进行财务查询时，系统不必为两个员工都新建FinancialReportManager，而可以让他们共享一个FinancialReportManager实例。</p> <p>通过这个示例，还可以进一步 了解享元工厂和对象池的一个重要区别。在一个对象池中，所有的对象都是等价的，任意两个对象在任何使用场景中都可以被对象池中的其他对象代替。而在享元模式中，享元工厂所维护的所有对象都是不同的，任何两个对象间不能互相代替。如本例中，为公司甲创建的FinancialReportManagerA 和为公司乙创建的FinancialReportManagerB 分别对应了后台各自不同的数据库，因此两者是不可相互替代的。</p> <p><strong>注意：享元模式和对象池的最大不同在于：享元对象是不可相互替代的，他们各自都有各自的含义和用途；而对象池中的对象都是等价的，如数据库连接池中的数据库连接。</strong></p> <p>本例中享元对象接口的实现如下，它用于创建一个报表。即，所有的报表生成类将作为享元对象在一个公司中共享。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IReportManager</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以下是两个报表生成的实例，分别对应员工财务收入报表和员工个人信息报表。他们都是具体的享元类。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//财务报表</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinancialReportManager</span> <span class="token keyword">implements</span> <span class="token class-name">IReportManager</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> tenantId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">FinancialReportManager</span><span class="token punctuation">(</span><span class="token class-name">String</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tenantId <span class="token operator">=</span> tenantId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;This is a financial report&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//员工报表</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmployeeReportManager</span> <span class="token keyword">implements</span> <span class="token class-name">IReportManager</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> tenantId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">EmployeeReportManager</span><span class="token punctuation">(</span><span class="token class-name">String</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tenantId <span class="token operator">=</span> tenantId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;This is a employee report&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最为核心的享元工厂类实现如下，它也是享元模式的精髓所在。它确保同一个公司（租户）使用相同的对象产生报表。这是相当有意义的，否则系统可能会为每个员工生成各自的报表对象，导致系统开销激增。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReportManagerFactory</span><span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">IReportManager</span><span class="token punctuation">&gt;</span></span> financialReportManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">IReportManager</span><span class="token punctuation">&gt;</span></span> employeeReportManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">IReportManager</span> <span class="token function">getFinancialReportManager</span><span class="token punctuation">(</span><span class="token class-name">String</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">IReportManager</span> r <span class="token operator">=</span> financialReportManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinancialReportManager</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            financialReportManager<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token keyword">public</span> <span class="token class-name">IReportManager</span> <span class="token function">getEmployeeReportManager</span><span class="token punctuation">(</span><span class="token class-name">String</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">IReportManager</span> r <span class="token operator">=</span> employeeReportManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinancialReportManager</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            employeeReportManager<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用享元模式的方法如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">ReportManagerFactory</span> rmf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReportManagerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IReportManager</span> rm <span class="token operator">=</span> rmf<span class="token punctuation">.</span><span class="token function">getFinancialReportManager</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>rm<span class="token punctuation">.</span><span class="token function">createReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ReportManagerFactory 作为享元工厂，以租客的ID为索引，维护了一个享元对象的集合，它确保相同租客的请求都返回同一个享元实例，确保享元对象的有效复用。</p></li></ol> <h2 id="_2-1-4-装饰者模式"><a href="#_2-1-4-装饰者模式" class="header-anchor">#</a> 2.1.4 装饰者模式</h2> <p>装饰者模式拥有一个设计非常巧妙的结构，它可以动态添加对象功能。在基本的设计原则中，有一条重要的设计准则叫做合成/聚合复用原则。根据该原则的思想，代码复用应该尽可能使用委托，而不是使用继承。因为继承是一种紧密耦合，任何父类的改动都会影响其子类，不利于系统维护。而委托则是松散耦合，只要接口不变，委托类的改动并不会影响其上层对象。</p> <p>装饰者模式就充分运用了这种思想，通过委托机制，复用系统中的各个组件，在运行时，可以将这些功能组件进行叠加，从而构成一个“超级对象”，使其拥有所有这些组件的功能。而各个子功能模块，被很好的维护在各个组件的相关类中，拥有整洁的系统结构。</p> <p><strong>注意：装饰者模式可以有效分离性能组件和功能组件，从而提升模块的可维护性并增加模块的复用性。</strong></p> <p>装饰者模式的基本结构图如图：</p> <p><img src="/assets/img/2.7.1593ffc8.png" alt=""></p> <p>装饰者（Decorator）和被装饰者（ConcreteComponent）拥有相同的接口Component。被装饰者通常是系统的核心组件，完成特定的功能目标。而装饰者则可以再被装饰者的方法前后，加上特定的前置处理和后置处理，增强被装饰者的功能。</p> <p>装饰者模式的主要角色如下：</p> <table><thead><tr><th>角色</th> <th>作用</th></tr></thead> <tbody><tr><td>组件接口</td> <td>组件接口是装饰者和被装饰者的超类或者接口。它定义了被装饰者的核心功能和装饰者需要加强的功能点</td></tr> <tr><td>具体组件</td> <td>具体组件实现了组件接口的核心方法，完成某一个具体的业务逻辑。它也是被装饰的对象</td></tr> <tr><td>装饰者</td> <td>实现组件接口，并持有一个具体的被装饰者对象</td></tr> <tr><td>具体装饰者</td> <td>具体实现装饰的业务逻辑，即实现了杯分离的各个增强功能点。各个具体装饰者是可以互相叠加的，从而可以构成一个功能更强大的组件对象。</td></tr></tbody></table> <p>装饰者模式的一个典型案例就是对输出结果进行增强。比如，现在需要将某一结果通过HTML进行发布，那么首先就需要将内容转化为一条HTML文本。同时，由于内容需要再网络上通过HTTP流传，故，还需要为其增加HTTP头。当然，作为一个更复杂的情况，可能还需要为其安置TCP头等。</p> <p>装饰者模式的核心思想在于：无需将所有的逻辑，即，核心内容构建、HTML文本构造和HTTP头生成等3个功能模块粘合在一起实现。通过装饰者模式，可以将它们分解为3个几乎完全独立的组件，并在使用时灵活的进行装配。为实现这个功能，可以使用如下结构：</p> <p><img src="/assets/img/2.8.2b17e218.png" alt=""></p> <p>IPacketCreator 即装饰接口，用于处理具体的内容。PacketBodyCreator 是具体的组件，它的功能是构造要发出信息的核心内容，但是它不负责将其构造成一个格式完整、可直接发布的数据格式。PacketHttpHeaderCreator 负责对给定的内容加上HTTP头部，PacketHtmlHeaderCreator负责将给定的内容格式化为HTML文本。如图2.8所示，3个功能模块相对独立且分离，易于系统维护。</p> <p>IPacketCreator 的实现很简单，它是一个但方法的接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPacketCreator</span> <span class="token punctuation">{</span>
	<span class="token comment">//用于内容处理</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> handleContent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PacketBodyCreator 用于返回数据保的核心数据：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketBodyCreator</span> <span class="token keyword">implements</span> <span class="token class-name">IPacketCreator</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//构造核心数据，但不包括格式</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Content of Packet&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PacketCreator 维护核心组件Component对象，它负责告知其子类，其核心业务逻辑应该全权委托 component 完成，自己仅仅是做增强处理。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">PacketDecorator</span> <span class="token keyword">implements</span> <span class="token class-name">IpacketCreator</span><span class="token punctuation">{</span>
    <span class="token class-name">IPacketCreator</span> component<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">PacketDecorator</span> <span class="token punctuation">(</span><span class="token class-name">IPacketCreator</span> c<span class="token punctuation">)</span><span class="token punctuation">{</span>
        component <span class="token operator">=</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PacketHtmlHeaderCreator 是具体的装饰器，它负责对核心发布的内容进行Html格式化操作。需要特别注意的是，它委托了具体组件Component进行核心业务处理。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketHtmlHeaderCreator</span> <span class="token keyword">extends</span> <span class="token class-name">PacketDecorator</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">PacketHtmlCreator</span><span class="token punctuation">(</span><span class="token class-name">IPacketCreator</span> c<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将给定数据封装成HTML</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;html&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;body&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span><span class="token function">handleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/body&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/html&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PacketHttpHeaderCreator 与PacketHtmmlHeaderCreator类似，但是它完成数据包HTTP头部的处理。其余业务处理依然交由内部的Component完成。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketHttpHeaderCreator</span> <span class="token keyword">extends</span> <span class="token class-name">PacketDecorator</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">PacketHttpHeaderCreator</span> <span class="token punctuation">(</span><span class="token class-name">IPacketCreator</span> c<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//对给定数据加上HTTP头信息</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;Cache-control:no-cache\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;Date:Mon,31Dec201204:25:57GMT\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span><span class="token function">handleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于装饰者模式，另外一个指的关注的地方是它的使用方法。在本例中，通过层层构造和组装这些装饰者和被装饰者到一个对象中，使其有机的结合在一起工作。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">IPacketCreator</span> pc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PacketHttpHeaderCreator</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">PacketHtmlheaderCreator</span><span class="token punctuation">(</span>
    	<span class="token keyword">new</span> <span class="token class-name">PacketBodyCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span><span class="token function">handleContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，通过装饰者的构造函数，将被装饰对象传入。本例中，共生成3个对象实例，作为核心组件的PacketBodyCreator最先被构造，其次是PacketHtmlHeaderCreator，最后才是PacketHttpHeaderCreator。</p> <p>这个顺序表示，首先由PacketBodyCreator对象去生成核心发布内容，接着由PacketHtmlHeaderCreator对象度这个内容进行处理，将其转换为HTML，最后由PacketHttpHeaderCreator对PacketHtmlHeaderCreator的输出安置HTTP头部。程序运行输出如下：</p> <div class="language-tex extra-class"><pre class="language-tex"><code>Cache-Control：no-Cache
Date:Mon,31Dec201204:25:57GMT
&lt;html&gt;&lt;body&gt;Content of Packet&lt;/body&gt;&lt;/html&gt;
</code></pre></div><p>图2.9是本例的调用堆栈，从调用堆栈中，读者应该可以更容易的理解各个组件的相互关系。</p> <p><img src="/assets/img/2.9.338cabe0.png" alt=""></p> <p>在JDK的实现中，有不少组件也是用装饰者模式实现。其中，一个最典型的例子就是OutputStream 和 InputStream 类族的实现。以OutputStream为例，OutputStream对象提供的方法比较简单，功能也比较弱，但通过各种装饰者的增强，OutputStream 对象可以被赋予强大的功能。</p> <p>图2.10显示了以OutputStream 为核心的装饰者模式的实现。其中FileOutputStream为：</p> <p><img src="/assets/img/2.10.257d751b.png" alt=""></p> <p>系统的核心类，它实现了想文件写入数据。使用DataOutputStream可以在FileOutputStream的基础上，增加对多种数据类型的写操作支持，而BufferedOutputStream装饰器，可以对FileOutputStream增加缓冲功能，优化I/O的性能。以BufferedOutputStream为代表的性能组件，是将性能模块和功能模块分离的一种典型实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">//生成一个有缓冲功能的流对象</span>
    <span class="token class-name">DataOutputStream</span> dout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>
    		<span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;C://a.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//没有缓冲功能的流对象</span>
    <span class="token class-name">DataOutputStream</span> dout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>
    		<span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;C://a.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        dout<span class="token punctuation">.</span><span class="token function">writeLong</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;speed:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码显示FileOutputStream 的典型应用。加粗部分是两种简历OutputStream 的方法，第一种加入了性能组件 BufferedOutputStream，第二种则没有。因此，第一种方法的 OutputStream 拥有更好的 I/O性能。</p> <p>**注意：JDK中OutputStream和 InputStream 类族的实现是装饰者模式的典型应用。通过嵌套的方式不断的将对象聚合起来，最终形成了一个超级对象，并使之拥有所有相关对象的功能。</p> <p>下面来看一下装饰者模式如何通过性能组件增强I/O性能。在运行时，工作流程如图2.11所示：</p> <p><img src="/assets/img/2.11.c3654d3e.png" alt=""></p> <p>在FileOutputStream.write()的调用之前，会首先调用BufferedOutputStream.write()，它的实现如下:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> synchroized <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span><span class="token keyword">int</span> off<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;=</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果要写入的数据量大于缓存容量</span>
        <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入所有缓存</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>off<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//直接将数据写入文件</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">&gt;</span> buf<span class="token punctuation">.</span>length<span class="token operator">-</span>count<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arrayCopy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>off<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>count<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    count <span class="token operator">+=</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里的out对象是 FileOutputStream</span>
        count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，并不是每次 BufferedOutputStream.write() 调用都会去磁盘写入数据，而是将数据写入缓存中，当缓存满时，才调用FileOutputStream.write() 方法，实际写入数据。以此实现性能组件和功能组件的完美分离。</p> <h2 id="_2-1-5-观察者模式"><a href="#_2-1-5-观察者模式" class="header-anchor">#</a> 2.1.5 观察者模式</h2> <p>观察者模式是非常常用的一种设计模式。在软件系统中，当一个对象的行为依赖于另外一个对象的状态时，观察者模式就相当有用。若不使用观察者模式提供的通用结构，而需要实现其类似的功能，则只能在另一个线程中不停的监听对象所依赖的状态。在一个复杂系统中，可能因此开启很多线程来实现这一功能，这将使系统的性能产生额外的负担。观察者模式的意义就在此，它可以在单线程中，使某一对象，及时得知自身所依赖的状态的变化。观察者模式的景点结构如图：</p> <p><img src="/assets/img/2.12.c64e0351.png" alt=""></p> <p>ISubject是被观察对象，它可以增加或者删除观察者。IOberver是观察者，它依赖ISubject的状态编号。当ISubject状态发生变化时，会通过inform()方法通知观察者。</p> <p><strong>注意：观察者模式可以用于事件监听、通知发布等场合。可以确保观察者在不使用轮询监控的情况下，及时收到相关消息和事件。</strong></p> <p>观察者模式的主要角色如下：</p> <table><thead><tr><th>角色</th> <th>作用</th></tr></thead> <tbody><tr><td>主题接口</td> <td>指被观察的对象。当其状态发生改变或某事件发生时，它会将这个变化通知观察者。它维护了观察者所需依赖的状态</td></tr> <tr><td>具体主题</td> <td>具体主题实现了主题即可中的方法。如新增观察者、删除观察者和通知观察者。其内部维护一个观察者列表</td></tr> <tr><td>观察者接口</td> <td>观察者接口定义了观察者的基本方法。当依赖状态发生改变时，主题接口就会调用观察者的update()方法</td></tr> <tr><td>具体观察者</td> <td>实现观察者接口的update()，具体处理当被观察者状态改变或某一时间发生时的业务逻辑</td></tr></tbody></table> <p>主题接口的实现如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISubject</span><span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">IObserver</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加观察者</span>
    <span class="token keyword">void</span> <span class="token function">detach</span><span class="token punctuation">(</span><span class="token class-name">IObserver</span> observer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除观察者</span>
    <span class="token keyword">void</span> <span class="token function">inform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//通知所有观察者</span>
<span class="token punctuation">}</span>
</code></pre></div><p>观察者接口如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IObserver</span><span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Event</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//更新观察者</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个具体的主题实现，注意，它维护了观察者队列，提供了增加和删除观察者的方法，并通过其inform()通知观察者。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteSubject</span> <span class="token keyword">implements</span> <span class="token class-name">ISubject</span><span class="token punctuation">{</span>
    <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IObserver</span><span class="token punctuation">&gt;</span></span> observers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IObserver</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">IObserver</span> observer<span class="token punctuation">)</span><span class="token punctuation">{</span>
       	observers<span class="token punctuation">.</span><span class="token function">addElement</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">detach</span><span class="token punctuation">(</span><span class="token class-name">IObserver</span> observer<span class="token punctuation">)</span><span class="token punctuation">{</span>
        observers<span class="token punctuation">.</span><span class="token function">removeElement</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Event</span> evt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">IObserver</span> ob<span class="token operator">:</span>observers<span class="token punctuation">)</span><span class="token punctuation">{</span>
            ob<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注意：在这里通知观察者</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个具体的观察者实现如下，当其监听的状态发生改变时，update()方法就会被主题回调，今儿可以在观察者内部进行业务逻辑处理。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteObserver</span> <span class="token keyword">implements</span> <span class="token class-name">IObserver</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Event</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;observer receives information&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>观察者模式是如此常用，以至于JDK内部就已经为开发人员准备了一套观察者模式的实现。它位于java.util 包中，包括 java.util.Observable 类 和 java.util.Observer 接口，他们的关系如图2.13所示：</p> <p><img src="/assets/img/2.13.2b227cfb.png" alt=""></p> <p>在java.util.Observable类中，已经实现了主要的功能，如增加观察者、删除观察者和通知观察者，开发人员可以直接通过继承Observable使用这些功能。java.util.Observable接口是观察者接口，他的update()方法会再java.util.Observable的notifyObserver()方法中被回调，以获得最新的状态变化。通常在观察者模式中Observer接口总是应用程序的核心扩展对象，具体的业务逻辑总是会被封装在update（）方法中。</p> <p>在JDK中，观察者模式也得到了普遍的应用。一个最典型的应用便是Swing框架的JButton实现，它的事件处理机制如图2.14所示。</p> <p>JButton继承自AbstractButton，在AbstractButton中维护了一组监听器，他们就扮演着被观察者的角色。而AbstractButton本身就是被观察对象。监听器ActionListener并不是依靠循环监听去获取按钮何时被单机，而是当按钮被单击时，通过AbstractButton的fireActionPermed()方法回调ActionListener.actionPerformed()方法实现。基于这种结构，在应用程序开发时，只需要简单的实现ActionListener接口（也就是Observer），并将其添加到按钮（Subject角色）的观察者列表中，那么当单机时间发生，就可以自动触发监听器的业务处理函数。下面观察者模式的角度分析一段按钮单击处理的代码：</p> <p><img src="/assets/img/2.4.746b69f5.png" alt=""></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//具体的观察者</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BtnListener</span> <span class="token keyword">implements</span> <span class="token class-name">ActionListener</span><span class="token punctuation">{</span>
    <span class="token comment">//在fireActionPerformed()中被回调</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">actionPerformed</span><span class="token punctuation">(</span><span class="token class-name">ActionEvent</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//按钮单击时，由具体观察者处理业务</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">JFrame</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JButton</span> btn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JButton</span><span class="token punctuation">(</span><span class="token string">&quot;Click Me&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新建具体主题</span>
    btn<span class="token punctuation">.</span><span class="token function">addActionListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BtnListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在具体主题中，加入观察者</span>
    p<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当按钮被单击时，通过被观察对象通知观察者，以下是AbstractButton 中的一段事件处理代码，显示了杯观察对象如何通知观察者：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fireActionPerformed</span><span class="token punctuation">(</span><span class="token class-name">ActionEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//这里就是应用层实现的ActionListener</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> listeners <span class="token operator">=</span> listenerList<span class="token punctuation">.</span><span class="token function">getListenerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ActionEvent</span> e <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>listeners<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">-=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token class-name">ActionListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">String</span> actionCommand <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getActionCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>actionCommand <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    actionCommand <span class="token operator">=</span> <span class="token function">getActionCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//构造事件参数，告诉应用层是何种事件发生</span>
                e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActionEvent</span><span class="token punctuation">(</span><span class="token class-name">AbstractButton</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                                   <span class="token class-name">ActionEvent</span><span class="token punctuation">.</span>ACTION_PERFORMED<span class="token punctuation">,</span>
                                   actionCommand<span class="token punctuation">,</span>
                                   event<span class="token punctuation">.</span><span class="token function">getWhen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   event<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//回调应用层的实现</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ActionListener</span><span class="token punctuation">)</span>listeners<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionPerformed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-1-6-value-object模式"><a href="#_2-1-6-value-object模式" class="header-anchor">#</a> 2.1.6 Value Object模式</h2> <p>在J2EE软件开发中，通常会对系统模块进行分层。展示层主要负责数据的展示，定义数据库的UI组织模式；业务逻辑层负责具体的业务逻辑处理；吃就吃通常指数据库以及相关操作。在一个大型系统中，这些层次很有可能被分离，并部署在不同的服务器上。而在两个层次之间，可能通过远程调用RMI等方式进行通信。如果2.15所示，展示层组件作为RMI的客户端，通过中间的业务逻辑层取得一个订单（Order）的信息。假设一个订单由客户名、商品名和数量构成，那么一次交互过程可能由图2.15所描述的这样，RMI的客户端会与服务端进行3次交互，依次取得这些信息。</p> <p><img src="/assets/img/2.15.7480c18e.png" alt=""></p> <p>基于以上模式的通信方式是一种可行的解决方案，但是它存在两个严重的问题：</p> <ol><li><p>对于获取一个订单对象而言，这个操作模式略显繁琐，且不具备较好的可维护性。</p></li> <li><p>前后累积进行3次客户端与服务端的通信，性能成本较高。</p> <p>为了解决这两个问题，就可以使用Value Object模式。Value Object模式提倡将一个对象的各个属性进行封装，将封装后的对象在网络中传递，从而使系统拥有更好的交互模型，并且减少网络通信数据，从而提高系统性能。使用Value Object模式对以上结构进行改良，定义对象Order，由Order对象维护客户名、商品名和数量等信息，而Order对象也就是Value Object，它必须是一个可串行化（序列化）的对象。将Value Object模式应用到本例中，便可以得到如图2.16所示的结构。</p> <p><img src="/assets/img/2.16.b9b5f39f.png" alt=""></p> <p>在基于Value Objecct 模式的结构中，为了获得一份订单信息，只需要进行一次网络通信，缩短了数据存取的响应时间，减少了网络数据流量。</p> <p><strong>注意：使用ValueObject模式可以有效减少网络交互次数，提高远程调用方法的性能，也能使系统接口具有更好的可维护性。</strong></p> <p>RMI服务端的接口实现如下，其中getOrder() 方法取得一个Value Object，其他方法均取得Order对象的一部分信息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOrderManager</span> <span class="token keyword">extends</span> <span class="token class-name">Remote</span><span class="token punctuation">{</span>
    <span class="token comment">// value Object模式</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProdName</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个最简单的IOrderManager的实现，它什么也没有做，只是返回数据：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderManager</span> <span class="token keyword">extends</span> <span class="token class-name">UnicastRemoteObject</span> <span class="token keyword">implements</span> <span class="token class-name">IOrderManager</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">OrdreManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1717013007581295639L</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">{</span>
        <span class="token comment">//返回订单信息</span>
        <span class="token class-name">Order</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span><span class="token function">setClientName</span><span class="token punctuation">(</span><span class="token string">&quot;billy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span><span class="token function">setProdunctName</span><span class="token punctuation">(</span><span class="token string">&quot;desk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">{</span>
        <span class="token comment">//返回订单的客户名</span>
        <span class="token keyword">return</span> <span class="token string">&quot;billy&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProdName</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">{</span>
        <span class="token comment">//返回商品名</span>
        <span class="token keyword">return</span> <span class="token string">&quot;desk&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">{</span>
        <span class="token comment">//返回数量</span>
        <span class="token keyword">return</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>作为Value Object 的Order 对象实现如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token keyword">implements</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token class-name">Serializable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> orderId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> clientName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> number<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> produnctName<span class="token punctuation">;</span>
    <span class="token comment">//省略 getter setter 方法</span>
<span class="token punctuation">}</span>
</code></pre></div><p>业务逻辑层注册并开启RMI服务器：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderManagerServer</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment">//注册RMI端口</span>
            <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//RMI远程对象</span>
            <span class="token class-name">IOrderManager</span> usermanager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//绑定RMI对象</span>
            <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">rebind</span><span class="token punctuation">(</span><span class="token string">&quot;OrderManager&quot;</span><span class="token punctuation">,</span>usermanager<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrderManager is ready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrdreManager server failed:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>客户端的测试代码如下，它分别展示了使用Value Object模式封装数据和不使用Value Object模式的性能差异：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mian</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token class-name">IOrderManager</span> usermananger <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IOrderManager</span><span class="token punctuation">)</span> <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;OrderManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//Value Object模式</span>
            usermanager<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;speed:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//通过多次交互获取数据</span>
            usermanager<span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            usermanager<span class="token punctuation">.</span><span class="token function">getNumbere</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            usermanager<span class="token punctuation">.</span><span class="token function">getProdName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;3 Method call speed:&quot;</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrdreManager exception:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果显示，使用getOrder（）方法相对耗时469ms，而使用连续3次离散的远程调用耗时766ms。由此可见，对传输数据进行有效的封装，可以明显提升远程方法调用的性能。</p></li></ol> <h2 id="_2-1-7-业务代理模式"><a href="#_2-1-7-业务代理模式" class="header-anchor">#</a> 2.1.7 业务代理模式</h2> <p>Value Object 模式是将远程调用传递数据封装在一个串行化的对象中进行传输，而业务代理模式则是将一组由远程方法调用构成的业务流程，封装在一个位于展示层的代理中。比如，如果用户需要修改一个订单，订单修改操作可细分为3个子操作：</p> <ul><li><p>校验用户</p></li> <li><p>获取旧的订单信息</p></li> <li><p>更新订单</p> <p>系统结构如图：2.17 所示：</p> <p><img src="/assets/img/2.17.c3c359f4.png" alt=""></p></li></ul> <p>以上结构存在两个问题：</p> <ol><li><p>当展示层存在大量并发线程时，这些线程都会直接进行远程方法调用，进而会加重网络负担。</p></li> <li><p>由于缺乏对订单修改操作流程的有效封装，如果将来流程发生变化，那么展示层组件需要修改。</p> <p>为了有效的解决以上两个问题，可以在展示层中加入业务代理对象，业务代理对象负责和远程服务器通信，完成订单修改操作。而业务代理对象本身只暴露简单的updatEOrder()订单修改操作供展示层组件使用，修改后的结构如图2.18所示：</p> <p><img src="/assets/img/2.18.3a0b4e3e.png" alt=""></p></li></ol> <p><strong>注意：业务代理模式将一些业务流程封装在前台系统，为系统性能优化提供了基础平台。在业务代理中，不仅可以复用业务流程，还可以视情况为展示层组件提供缓存等功能，从而减少远程方法调用次数，降低系统压力。</strong></p> <p>这种结构体现了业务代理模式的核心思想。由于该业务代理对象被所有的展示层请求线程和多个客户端共享，故系统将会有较好的可维护性。如果业务流程发生变化，只需要简单的修改业务代理对象暴露的updateOrder()方法即可。除此之外，通过业务代理对象，可以更容易的再讴歌线程或者客户端请求之间共享数据，从而有效的利用缓存，减少远程调用测试，提高系统性能。</p> <p>一个未使用业务代理模式的展示层实现可能如下所示：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token class-name">IOrderManager</span> usermananger <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IOrderManager</span><span class="token punctuation">)</span> <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;OrderManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>usermanager<span class="token punctuation">.</span><span class="token function">checkUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">//所有的远程调用都会被执行，当并发量较大时，严重影响性能</span>
            <span class="token class-name">Order</span> o <span class="token operator">=</span> usermanager<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            usermanager<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OrdreManager exception:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而使用了业务代理后，展示层组件可以优化成：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">BusinessDelegate</span> bd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BussinessDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Order</span> o <span class="token operator">=</span> bd<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bd<span class="token punctuation">.</span><span class="token function">updateOrdre</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在业务代理对象 BusinessDelegate 中，可以增加缓存，从而直接减少远程调用的次数。以下是一段不完整的实例代码，但足以说明问题：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessDelegate</span> <span class="token punctuation">{</span>
    <span class="token class-name">IOrderManager</span> usermanager <span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//封装远程方法调用流程</span>
    <span class="token keyword">public</span> <span class="token class-name">BusinessDelegate</span>（）<span class="token punctuation">{</span>
        usermanager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IOrderManager</span><span class="token punctuation">)</span> <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;OrderManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">checkUserFromCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">checkUser</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">{</span>
        <span class="token comment">//当前对象被多个客户端共享，可以再本地缓存中校验用户</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkUserFromCache</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> usermanager<span class="token punctuation">.</span><span class="token function">checkUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrderFromCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token keyword">int</span> oid<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">{</span>
        <span class="token comment">//可以再本地缓存中获取订单，减少远程调用次数</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token function">getOrderFromCache</span><span class="token punctuation">(</span>oid<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> usermanager<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>oid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//暴露给展示层的方法，封装了业务路程，可能在缓存中执行</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">checkUser</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            o<span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            usermanager<span class="token punctuation">.</span><span class="token function">updateOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/15/2023, 8:18:50 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/javaxing-neng-diao-you-gai-shu/di-1zhang-javaxing-neng-diao-you-gai-shu/ji-ben-diao-you-ce-lue-he-shou-duan-.html" class="prev">
        1.3 基本调优策略和手段
      </a></span> <span class="next"><a href="/javaxing-neng-diao-you-gai-shu/di-2zhang-she-ji-you-hua/chang-yong-you-hua-zu-jian-he-fang-fa.html">
        2.2 常用优化组件和方法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d9144f6d.js" defer></script><script src="/assets/js/2.37ae8396.js" defer></script><script src="/assets/js/3.5aeea859.js" defer></script>
  </body>
</html>
